# P0.3 / P0.3.1 Demo Script – FX & Ledger Hardening

Bu doküman, P0.3 ve P0.3.1 kapsamında oluşturulan **EUR-only ledger mimarisi** ve
**refund reversal net-0 kanıtı** için canlı demoda kullanabileceğiniz adım adım
komutları ve ekran akışlarını içerir.

## 1. Hazırlık

### 1.1. Ortam Bilgileri

- Backend base URL: `$REACT_APP_BACKEND_URL`
- Admin kullanıcı: `admin@acenta.test / admin123`
- Agency kullanıcı: `agency1@demo.test / agency123`

Terminallerde her zaman aşağıdaki ortam değişkenini set edin:

```bash
export API_URL="${REACT_APP_BACKEND_URL}"
```

> Not: Demo sırasında **doğrudan localhost portu** kullanmak yerine her zaman
> ingress üzerinden gelen `$REACT_APP_BACKEND_URL` adresini kullanın.

---

## 2. P0.2 Booking Zinciri (Özet – zaten kanıtlanmış)

Bu adım, P0.2 Search→Quote→Booking zincirinin canlı olduğunu hızlıca
hatırlatmak içindir.

### 2.1. Agency ile Login ve Booking Oluşturma (UI)

1. Tarayıcıda `…/app/login` sayfasını açın.
2. Agency kullanıcısı ile giriş yapın: `agency1@demo.test / agency123`.
3. Menüden **"Otel Arama" / ilgili B2B sayfasına** gidin.
4. İstanbul için 2 gecelik (2026-01-10 → 2026-01-12) arama yapın.
5. Gelen sonuçlardan herhangi birini seçerek:
   - Quote oluşturun,
   - Ardından booking’i CONFIRMED statüsüne getirin.
6. Sonuçta /app/agency/bookings listesinde yeni booking’i en üstte
   görmelisiniz.

> Bu adım, daha sonra kullanacağımız `booking_id`’yi UI üzerinden
> bulmak için gerekli. Terminal tarafında kullanmak isterseniz
> `/api/b2b/bookings` ile de çekebilirsiniz.

### 2.2. Booking’leri API üzerinden listeleme (Ops debug amaçlı)

```bash
# Admin token al
ADMIN_TOKEN=$(curl -s -X POST "$API_URL/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@acenta.test","password":"admin123"}' | \
  python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")

# Agency booking listesini çek (ops perspektifi için gerekirse)
curl -s -X GET "$API_URL/api/b2b/bookings" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq
```

> Demo sırasında burada sadece `booking_id`’yi not etmek yeterli.

---

## 3. Booking Ledger Özeti – UI & API ile Balance Proof (P0.3.1 U1)

Bu bölüm, **DB’ye girmeden** bir booking’in ledger dengesini hem UI’de hem de
API’de gösterir.

### 3.1. UI: Booking Detail Drawer → “Ledger Özeti” Bloğu

1. Tarayıcıda agency kullanıcısı ile `/app/agency/bookings` sayfasına gidin.
2. Listeden az önce oluşturduğunuz CONFIRMED booking satırına tıklayın.
3. Sağdan açılan **BookingDetailDrawer** içinde aşağıya doğru inin.
4. "**Ledger Özeti**" bölümünde şu alanları göreceksiniz (örnek):
   - Para Birimi: `EUR`
   - Kayıt Sayısı: `2`
   - Toplam Debit: `1650.00`
   - Toplam Credit: `1650.00`
   - Fark (Debit - Credit): `0.0000`
   - Event Seti: `BOOKING_CONFIRMED` (ve varsa `REFUND_APPROVED` vb.)
   - Kaynak Koleksiyon: `ledger_postings` (veya fallback ile `ledger_entries`)

> Eğer bu booking için henüz ledger kaydı yoksa, aynı blokta:
> `Bu booking için henüz ledger kaydı bulunamadı.` mesajı gözükür.
> Demo’da bu durum da “beklenen empty state” olarak not edilebilir.

### 3.2. API: GET /api/ops/finance/bookings/{id}/ledger-summary

Aynı booking için terminal üzerinden de aynı sayıları gösterelim.

```bash
# Daha önce aldığınız ADMIN_TOKEN'ı kullanın
BOOKING_ID="<UI'dan aldığınız booking_id>"

curl -s -X GET "$API_URL/api/ops/finance/bookings/$BOOKING_ID/ledger-summary" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq
```

Beklenen örnek response:

```json
{
  "booking_id": "...",
  "organization_id": "...",
  "currency": "EUR",
  "source_collection": "ledger_postings",
  "postings_count": 2,
  "total_debit": 1650.0,
  "total_credit": 1650.0,
  "diff": 0.0,
  "events": ["BOOKING_CONFIRMED"]
}
```

> Demo mesajı: **"DB’ye girmeden, hem UI hem API üzerinden bu booking’in
> ledger’ının tam dengede olduğunu görebiliyoruz; tüm kayıtlar EUR ve
debit = credit."**

Hata/edge durumları (ops debug için):

```bash
# Geçersiz ObjectId formatı → 404 booking_not_found
curl -s -X GET "$API_URL/api/ops/finance/bookings/NOT_A_VALID_ID/ledger-summary" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq

# Doğru formatlı ama olmayan ID → yine 404 booking_not_found
curl -s -X GET "$API_URL/api/ops/finance/bookings/000000000000000000000000/ledger-summary" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq
```

---

## 4. Net-0 Reversal Kanıtı – _test/posting ile (P0.3.1 core proof)

Bu bölüm, gerçek booking/refund akışına dokunmadan sadece ledger’in Phase 1
**event matrisi** üzerinden refund reversal’ın net-0 etkisini kanıtlar.

### 4.1. BOOKING_CONFIRMED + REFUND_APPROVED Net-0 – pytest

Tek komutla tüm kanıtı çalıştırabilirsiniz:

```bash
cd /app/backend
pytest tests/test_ledger_reversal_net_zero.py -q
```

Beklenen çıktı:

- 1 test passed
- Hiç failure/xfail yok

Bu testin yaptığı özetle şudur:

- `/api/ops/finance/_test/posting` ile aynı `source_id` için önce
  `BOOKING_CONFIRMED`, sonra `REFUND_APPROVED` event’lerini yaratır.
- `ledger_postings` (ve gerekiyorsa `ledger_entries`) üzerinden:
  - Her event seti kendi içinde balanced (`debit ≈ credit`),
  - İkisi birlikte ele alındığında **net EUR etkisi ~0** olduğunu assert eder.

### 4.2. Aynı Senaryoyu Terminalden Manuel Oynatmak (Ops cheat)

İsterseniz, aynı mantığı manuel olarak da gösterebilirsiniz.

```bash
cd /app

# 1) Admin token
ADMIN_TOKEN=$(curl -s -X POST "$API_URL/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@acenta.test","password":"admin123"}' | \
  python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")

# 2) Organization'daki ilk agency/platform hesaplarını bul (EUR)
python3 << 'PY'
import os, asyncio, json
from motor.motor_asyncio import AsyncIOMotorClient

mongo_url = os.environ.get("MONGO_URL")
client = AsyncIOMotorClient(mongo_url)
db = client[os.environ.get("DB_NAME", "test_database")]

async def main():
    org = await db.organizations.find_one({})
    org_id = org.get("id") or str(org.get("_id"))

    agency = await db.finance_accounts.find_one({"organization_id": org_id, "type": "agency", "currency": "EUR"})
    platform = await db.finance_accounts.find_one({"organization_id": org_id, "type": "platform", "currency": "EUR"})

    out = {
        "organization_id": org_id,
        "agency_account_id": agency["_id"],
        "platform_account_id": platform["_id"],
    }
    print(json.dumps(out))

asyncio.run(main())
PY
```

Çıktıdan `AGENCY_ACCOUNT_ID` ve `PLATFORM_ACCOUNT_ID`’yi alıp:

```bash
SOURCE_ID="P0.3.1_NET0_DEMO"

# 3) BOOKING_CONFIRMED (1000 EUR)
curl -s -X POST "$API_URL/api/ops/finance/_test/posting" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "source_type": "booking",
    "source_id": "'