# P0.3 / P0.3.1 Demo Script – FX & Ledger Hardening

Bu doküman, P0.3 ve P0.3.1 kapsamında oluşturulan **EUR-only ledger mimarisi** ve
**refund reversal net-0 kanıtı** için canlı demoda kullanabileceğiniz adım adım
komutları ve ekran akışlarını içerir.

## 1. Hazırlık

### 1.1. Ortam Bilgileri

- Backend base URL: `$REACT_APP_BACKEND_URL`
- Admin kullanıcı: `admin@acenta.test / admin123`
- Agency kullanıcı: `agency1@demo.test / agency123`

Terminallerde her zaman aşağıdaki ortam değişkenini set edin:

```bash
export API_URL="${REACT_APP_BACKEND_URL}"
```

> Not: Demo sırasında **doğrudan localhost portu** kullanmak yerine her zaman
> ingress üzerinden gelen `$REACT_APP_BACKEND_URL` adresini kullanın.

---

## 2. P0.2 Booking Zinciri (Özet – zaten kanıtlanmış)

Bu adım, P0.2 Search→Quote→Booking zincirinin canlı olduğunu hızlıca
hatırlatmak içindir.

### 2.1. Agency ile Login ve Booking Oluşturma (UI)

1. Tarayıcıda `…/app/login` sayfasını açın.
2. Agency kullanıcısı ile giriş yapın: `agency1@demo.test / agency123`.
3. Menüden **"Otel Arama" / ilgili B2B sayfasına** gidin.
4. İstanbul için 2 gecelik (2026-01-10 → 2026-01-12) arama yapın.
5. Gelen sonuçlardan herhangi birini seçerek:
   - Quote oluşturun,
   - Ardından booking’i CONFIRMED statüsüne getirin.
6. Sonuçta /app/agency/bookings listesinde yeni booking’i en üstte
   görmelisiniz.

> Bu adım, daha sonra kullanacağımız `booking_id`’yi UI üzerinden
> bulmak için gerekli. Terminal tarafında kullanmak isterseniz
> `/api/b2b/bookings` ile de çekebilirsiniz.

### 2.2. Booking’leri API üzerinden listeleme (Ops debug amaçlı)

```bash
# Admin token al
ADMIN_TOKEN=$(curl -s -X POST "$API_URL/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@acenta.test","password":"admin123"}' | \
  python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")

# Agency booking listesini çek (ops perspektifi için gerekirse)
curl -s -X GET "$API_URL/api/b2b/bookings" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq
```

> Demo sırasında burada sadece `booking_id`’yi not etmek yeterli.

---

## 3. Booking Ledger Özeti – UI & API ile Balance Proof (P0.3.1 U1)

Bu bölüm, **DB’ye girmeden** bir booking’in ledger dengesini hem UI’de hem de
API’de gösterir.

### 3.1. UI: Booking Detail Drawer → “Ledger Özeti” Bloğu

1. Tarayıcıda agency kullanıcısı ile `/app/agency/bookings` sayfasına gidin.
2. Listeden az önce oluşturduğunuz CONFIRMED booking satırına tıklayın.
3. Sağdan açılan **BookingDetailDrawer** içinde aşağıya doğru inin.
4. "**Ledger Özeti**" bölümünde şu alanları göreceksiniz (örnek):
   - Para Birimi: `EUR`
   - Kayıt Sayısı: `2`
   - Toplam Debit: `1650.00`
   - Toplam Credit: `1650.00`
   - Fark (Debit - Credit): `0.0000`
   - Event Seti: `BOOKING_CONFIRMED` (ve varsa `REFUND_APPROVED` vb.)
   - Kaynak Koleksiyon: `ledger_postings` (veya fallback ile `ledger_entries`)

> Eğer bu booking için henüz ledger kaydı yoksa, aynı blokta:
> `Bu booking için henüz ledger kaydı bulunamadı.` mesajı gözükür.
> Demo’da bu durum da “beklenen empty state” olarak not edilebilir.

### 3.2. API: GET /api/ops/finance/bookings/{id}/ledger-summary

Aynı booking için terminal üzerinden de aynı sayıları gösterelim.

```bash
# Daha önce aldığınız ADMIN_TOKEN'ı kullanın
BOOKING_ID="<UI'dan aldığınız booking_id>"

curl -s -X GET "$API_URL/api/ops/finance/bookings/$BOOKING_ID/ledger-summary" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq
```

Beklenen örnek response:

```json
{
  "booking_id": "...",
  "organization_id": "...",
  "currency": "EUR",
  "source_collection": "ledger_postings",
  "postings_count": 2,
  "total_debit": 1650.0,
  "total_credit": 1650.0,
  "diff": 0.0,
  "events": ["BOOKING_CONFIRMED"]
}
```

> Demo mesajı: **"DB’ye girmeden, hem UI hem API üzerinden bu booking’in
> ledger’ının tam dengede olduğunu görebiliyoruz; tüm kayıtlar EUR ve
debit = credit."**

Hata/edge durumları (ops debug için):

```bash
# Geçersiz ObjectId formatı → 404 booking_not_found
curl -s -X GET "$API_URL/api/ops/finance/bookings/NOT_A_VALID_ID/ledger-summary" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq

# Doğru formatlı ama olmayan ID → yine 404 booking_not_found
curl -s -X GET "$API_URL/api/ops/finance/bookings/000000000000000000000000/ledger-summary" \
  -H "Authorization: Bearer $ADMIN_TOKEN" | jq
```

---

## 4. TRY Selling → EUR Ledger Standardization (P1.1 Preview)

Bu bölüm, P1.1 ile birlikte devreye alınan TRY satış para biriminin, yine de
EUR-defteri standardı ile nasıl uyumlu kaldığını gösterir.

> **Tek cümlelik mesaj:** "Satış para birimi TRY olsa bile muhasebe defteri tek
> standartta EUR; dönüşüm kaynağı booking snapshot ve idempotent."

### 4.1. TRY Booking Oluşturma (UI)

1. Tarayıcıda `…/app/login` sayfasını açın.
2. Agency kullanıcısı ile giriş yapın: `agency1@demo.test / agency123`.
3. `/app/agency/hotels` ekranına gidin.
4. P0.2 Search → Quote → Booking akışını kullanarak yeni bir booking oluşturun.
5. Booking oluşturulduktan sonra:
   - Kartlarda ve özetlerde fiyatın `TRY` olarak gösterildiğini görmelisiniz
     (ör: `2200 TRY`).

### 4.2. Booking Dokümanı (TRY + EUR Snapshot)

Terminalden, az önce oluşturduğunuz booking'i inceleyin:

```bash
BOOKING_ID="<UI'dan aldığınız TRY booking_id>"

python3 << 'PY'
import os, asyncio, json
from motor.motor_asyncio import AsyncIOMotorClient

mongo_url = os.environ.get("MONGO_URL")
client = AsyncIOMotorClient(mongo_url)
db = client[os.environ.get("DB_NAME", "test_database")]

async def main():
    booking = await db.bookings.find_one({"_id": __import__("bson").ObjectId("'""$BOOKING_ID""'"),})
    # Demo için sadeleştirilmiş çıktı
    out = {
        "currency": booking.get("currency"),
        "amounts": booking.get("amounts"),
        "fx": booking.get("fx"),
    }
    print(json.dumps(out, default=str, indent=2))

asyncio.run(main())
PY
```

Beklenen yapı (özet):

```json
{
  "currency": "TRY",
  "amounts": {
    "sell": 2200.0,
    "sell_eur": 62.5
  },
  "fx": {
    "base": "EUR",
    "quote": "TRY",
    "rate": 35.2,
    "rate_basis": "QUOTE_PER_EUR",
    "as_of": "...",
    "snapshot_id": "..."
  }
}
```

> Mesaj: **"Booking TRY satıyor, ancak amounts.sell_eur alanı sayesinde defter
> için EUR karşılığı deterministik olarak kilitlenmiş durumda."**

### 4.3. EUR Defter Kaydı (Ledger Posting)

Aynı booking için EUR-defter kaydını gösterin:

```bash
python3 << 'PY'
import os, asyncio
from motor.motor_asyncio import AsyncIOMotorClient

mongo_url = os.environ.get("MONGO_URL")
client = AsyncIOMotorClient(mongo_url)
db = client[os.environ.get("DB_NAME", "test_database")]

BOOKING_ID = "'""$BOOKING_ID""'"

async def main():
    booking = await db.bookings.find_one({"_id": __import__("bson").ObjectId(BOOKING_ID)})
    org_id = booking["organization_id"]
    sell_eur = float((booking.get("amounts") or {}).get("sell_eur", 0.0))

    cursor = db.ledger_postings.find({
        "organization_id": org_id,
        "source.type": "booking",
        "source.id": BOOKING_ID,
        "event": "BOOKING_CONFIRMED",
    })
    docs = await cursor.to_list(length=10)
    total_debit = sum(float(d.get("debit", 0.0) or 0.0) for d in docs)
    total_credit = sum(float(d.get("credit", 0.0) or 0.0) for d in docs)
    ccys = {d.get("currency") for d in docs}

    print("CURRENCIES", ccys)
    print("TOTAL_DEBIT", total_debit)
    print("TOTAL_CREDIT", total_credit)
    print("SELL_EUR", sell_eur)
    print("DIFF", total_debit - total_credit)

asyncio.run(main())
PY
```

Beklenti:

- `CURRENCIES` sadece `{"EUR"}` içermeli.
- `TOTAL_DEBIT ≈ TOTAL_CREDIT ≈ SELL_EUR` olmalı.

> Mesaj: **"Satış TRY olsa bile, ledger_postings tamamen EUR standardında; miktar
> booking.amounts.sell_eur üzerinden geliyor ve dengeli."**

### 4.4. Otomatik Kanıt: P1.1 TRY Flow Testi (pytest)

Son olarak, tüm bu zinciri tek testle kanıtlayın:

```bash
cd /app/backend
pytest tests/test_non_eur_booking_fx_and_ledger.py -q
```

Beklenen davranış:

- TRY booking varsa: **PASS**
- Hâlâ EUR-only ortamda iseniz (henüz TRY booking yaratılmadıysa):
  test, `Non-EUR P1.1 flow not yet active...` mesajı ile **SKIP** olur.

> Mesaj: **"Bu test, booking TRY + FX snapshot + booking_financials + EUR
> ledger-posting zincirinin tamamını otomatik olarak doğruluyor."**

---

## 5. P1.2 Rule-based Pricing – Agency Bazlı Markup Farkı

Bu bölüm, P1.2 kapsamında devreye alınan rule-based pricing motorunun,
aynı ürün ve tarihler için farklı acentelere farklı markup uyguladığını
(görünür fiyat farkı) gösterir.

### 5.1. Agency1 ve Agency2 için Quotes (UI veya API)

Seed ile birlikte aşağıdaki demo kuralları otomatik oluşur:

- Kural 1 (default hotel): product_type="hotel", priority=100, markup_percent=10.0
- Kural 2 (agency1 özel): product_type="hotel", agency_id=Demo Acente A, priority=200, markup_percent=12.0

Semantik:

- Demo Acente A (agency1) → ~%12 markup
- Demo Acente B (default) → ~%10 markup

#### 5.1.1. UI üzerinden hızlı gözlem

1. `admin@acenta.test` ile login olup Agency kullanıcılarını doğrulayın (ops isteğe bağlı).
2. `agency1@demo.test / agency123` ile login → `/app/agency/hotels` üzerinden bir arama yapın.
3. Aynı akışı (aynı tarih, aynı otel) Demo Acente B kullanıcısı ile de tekrarlayın
   (seed ile ikinci acente ve kullanıcı geldiğinde).
4. Kartlarda ve teklif özetinde Demo Acente A için fiyatın Demo Acente B'den
   bir miktar daha yüksek olduğunu göreceksiniz.

> Not: UI'da doğrudan "%12" veya "%10" gösterilmiyor; fark fiyatlar üzerinden
> gözlemleniyor. Asıl kanıtı terminal/pytest ile alıyoruz.

### 5.2. API ile net oranların kanıtı (sell/net)

Aşağıdaki adımlar, aynı ürüne ait iki farklı acente için **sell/net oranı**
üzerinden kural motorunu kanıtlar.

```bash
# 1) Admin token al
ADMIN_TOKEN=$(curl -s -X POST "$API_URL/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@acenta.test","password":"admin123"}' | \
  python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")

# 2) Demo Acente A ve B'yi bul
python3 << 'PY'
import os, asyncio, json
from motor.motor_asyncio import AsyncIOMotorClient

mongo_url = os.environ.get("MONGO_URL")
client = AsyncIOMotorClient(mongo_url)
db = client[os.environ.get("DB_NAME", "test_database")]

async def main():
    org = await db.organizations.find_one({})
    org_id = org.get("id") or str(org.get("_id"))

    a1 = await db.agencies.find_one({"organization_id": org_id, "name": "Demo Acente A"})
    a2 = await db.agencies.find_one({"organization_id": org_id, "name": "Demo Acente B"})

    inv = await db.inventory.find_one({"organization_id": org_id})

    out = {
        "organization_id": org_id,
        "agency1_id": a1["_id"] if a1 else None,
        "agency2_id": a2["_id"] if a2 else None,
        "product_id": str(inv["product_id"]) if inv else None,
        "date": inv["date"] if inv else None,
    }
    print(json.dumps(out))

asyncio.run(main())
PY
```

Çıktıdan `AGENCY1_ID`, `AGENCY2_ID`, `PRODUCT_ID` ve `DATE` değerlerini alın.

```bash
AGENCY1_ID="<Demo Acente A _id>"
AGENCY2_ID="<Demo Acente B _id>"
PRODUCT_ID="<PRODUCT_ID>"
CHECK_IN_DATE="<DATE>"
CHECK_OUT_DATE=$(python3 - << 'PY'
from datetime import date, timedelta
import os
ci = date.fromisoformat(os.environ["CHECK_IN_DATE"])
print((ci + timedelta(days=1)).isoformat())
PY)
```

Şimdi iki farklı acente kullanıcısı için quote isteği atabilir veya
backend testini referans alabilirsiniz. Backend test senaryosu:

```bash
cd /app/backend
pytest tests/test_quote_pricing_uses_rules.py -q
```

Beklenti:

- Demo Acente A (agency1) için ilk offer'da sell/net oranı ~**1.12**
- Demo Acente B için aynı ürün ve tarihte sell/net oranı ~**1.10**

> Mesaj: **"Aynı ürün ve tarihte, sadece acente değişerek fiyat farkı
> oluşuyor; bu fark P1.2 pricing_rules motorunun agency + product + date
> bazlı markup kurallarından geliyor."**

---

## 6. Net-0 Reversal Kanıtı – _test/posting ile (P0.3.1 core proof)

Bu bölüm, gerçek booking/refund akışına dokunmadan sadece ledger’in Phase 1
**event matrisi** üzerinden refund reversal’ın net-0 etkisini kanıtlar.

### 4.1. BOOKING_CONFIRMED + REFUND_APPROVED Net-0 – pytest

Tek komutla tüm kanıtı çalıştırabilirsiniz:

```bash
cd /app/backend
pytest tests/test_ledger_reversal_net_zero.py -q
```

Beklenen çıktı:

- 1 test passed
- Hiç failure/xfail yok

Bu testin yaptığı özetle şudur:

- `/api/ops/finance/_test/posting` ile aynı `source_id` için önce
  `BOOKING_CONFIRMED`, sonra `REFUND_APPROVED` event’lerini yaratır.
- `ledger_postings` (ve gerekiyorsa `ledger_entries`) üzerinden:
  - Her event seti kendi içinde balanced (`debit ≈ credit`),
  - İkisi birlikte ele alındığında **net EUR etkisi ~0** olduğunu assert eder.

### 4.2. Aynı Senaryoyu Terminalden Manuel Oynatmak (Ops cheat)

İsterseniz, aynı mantığı manuel olarak da gösterebilirsiniz.

```bash
cd /app

# 1) Admin token
ADMIN_TOKEN=$(curl -s -X POST "$API_URL/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@acenta.test","password":"admin123"}' | \
  python3 -c "import sys,json; print(json.load(sys.stdin)['token'])")

# 2) Organization'daki ilk agency/platform hesaplarını bul (EUR)
python3 << 'PY'
import os, asyncio, json
from motor.motor_asyncio import AsyncIOMotorClient

mongo_url = os.environ.get("MONGO_URL")
client = AsyncIOMotorClient(mongo_url)
db = client[os.environ.get("DB_NAME", "test_database")]

async def main():
    org = await db.organizations.find_one({})
    org_id = org.get("id") or str(org.get("_id"))

    agency = await db.finance_accounts.find_one({"organization_id": org_id, "type": "agency", "currency": "EUR"})
    platform = await db.finance_accounts.find_one({"organization_id": org_id, "type": "platform", "currency": "EUR"})

    out = {
        "organization_id": org_id,
        "agency_account_id": agency["_id"],
        "platform_account_id": platform["_id"],
    }
    print(json.dumps(out))

asyncio.run(main())
PY
```

Çıktıdan `AGENCY_ACCOUNT_ID` ve `PLATFORM_ACCOUNT_ID`’yi alıp:

```bash
SOURCE_ID="P0.3.1_NET0_DEMO"

# 3) BOOKING_CONFIRMED (1000 EUR)
curl -s -X POST "$API_URL/api/ops/finance/_test/posting" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "source_type": "booking",
    "source_id": "'"$SOURCE_ID"'"',
    "event": "BOOKING_CONFIRMED",
    "agency_account_id": "<AGENCY_ACCOUNT_ID>",
    "platform_account_id": "<PLATFORM_ACCOUNT_ID>",
    "amount": 1000.0
  }' | jq

# 4) REFUND_APPROVED (1000 EUR)
curl -s -X POST "$API_URL/api/ops/finance/_test/posting" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "source_type": "booking",
    "source_id": "'"$SOURCE_ID"'"',
    "event": "REFUND_APPROVED",
    "agency_account_id": "<AGENCY_ACCOUNT_ID>",
    "platform_account_id": "<PLATFORM_ACCOUNT_ID>",
    "amount": 1000.0
  }' | jq

# 5) Net EUR etkisini aggregate ile kontrol et
python3 << 'PY'
import os, asyncio
from motor.motor_asyncio import AsyncIOMotorClient

mongo_url = os.environ.get("MONGO_URL")
client = AsyncIOMotorClient(mongo_url)
db = client[os.environ.get("DB_NAME", "test_database")]

ORG_ID = None
SOURCE_ID = "P0.3.1_NET0_DEMO"

async def main():
    from pprint import pprint
    # Org id'yi ilk organization kaydından al
    org = await db.organizations.find_one({})
    org_id = org.get("id") or str(org.get("_id"))

    cursor = db.ledger_postings.find({
        "organization_id": org_id,
        "source.type": "booking",
        "source.id": SOURCE_ID,
    })
    docs = await cursor.to_list(length=10)
    total_debit = sum(float(d.get("debit", 0.0) or 0.0) for d in docs)
    total_credit = sum(float(d.get("credit", 0.0) or 0.0) for d in docs)
    print("POSTINGS_COUNT", len(docs))
    print("TOTAL_DEBIT", total_debit)
    print("TOTAL_CREDIT", total_credit)
    print("DIFF", total_debit - total_credit)

asyncio.run(main())
PY
```

> Demo mesajı: **"Test endpoint ile tek booking kaynağı için önce satış,
> sonra refund event'i post ediyoruz; ledger_postings üzerinde debit ve
> credit toplamları eşit, yani net EUR etkisi ≈ 0."**